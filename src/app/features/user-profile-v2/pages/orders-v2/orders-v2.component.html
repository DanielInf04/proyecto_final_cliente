<!-- Mostrar título y pedidos solo si hay -->
<ng-container *ngIf="!isLoading && pedidos.length > 0">
  <h3 class="fw-bold mb-1 mt-4">Mis pedidos</h3>
  <p class="text-muted">Aquí encontrarás tus pedidos online.</p>

  <div *ngFor="let pedido of pedidos" class="row g-4 mb-4">
    <!-- Tarjeta izquierda -->
    <div class="col-md-4">
      <div class="order-card-left p-4 rounded-4" style="background-color: #f1f8f6; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
        <div class="mb-3">
          <h5 class="fw-bold mb-1">{{ pedido.fecha_pedido | date:'dd MMMM y' }}</h5>
          <small class="text-muted">Pedido Online — {{ pedido.fecha_pedido | date:'HH:mm' }}</small>
        </div>

        <div class="mb-3">
          <span class="badge text-uppercase p-2"
              [ngClass]="{
                  'bg-success': pedido.estado_pago === 'pagado',
                  'bg-warning text-dark': pedido.estado_pago === 'pendiente',
                  'bg-danger': pedido.estado_pago === 'fallido'
              }">
            {{ pedido.estado_pago | titlecase }}
          </span>
        </div>

        <div class="mb-2 border-top pt-3">
          <p class="mb-1"><strong>N.º de pedido:</strong> {{ pedido.id }}</p>
          <p class="mb-1"><strong>Total:</strong> €{{ pedido.total }}</p>
        </div>

        <button class="btn btn-success w-100 fw-semibold mt-3"
                [routerLink]="['/user-profile-v2/orders/detail-order/', pedido.id]">
          Ver detalles del pedido
        </button>
      </div>
    </div>

    <!-- Tarjeta derecha -->
    <div class="col-md-8">
      <div class="order-card-right p-4 rounded-4" style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
        <h6 class="fw-bold mb-3 border-bottom pb-2">Resumen de la compra</h6>

        <div *ngFor="let empresa of pedido.empresas">
          <div *ngFor="let prod of empresa.productos" class="d-flex align-items-start mb-4">
            <a [routerLink]="['/producto', prod.producto_id]">
              <img [src]="prod.imagen" alt="{{ prod.nombre }}"
                   class="me-3"
                   style="width: 140px; height: auto; max-height: 140px; cursor: pointer;">
            </a>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between">
                <p class="fw-semibold mb-1 mb-md-0 me-2 flex-grow-1 text-wrap">{{ prod.nombre }}</p>
                <span class="fw-semibold text-nowrap">{{ prod.precio_unitario }}€</span>
              </div>
              <small class="text-muted d-block mb-2">Cantidad: {{ prod.cantidad }}</small>

              <div *ngIf="prod.valoracion_cliente; else valorar">
                <ng-container *ngFor="let estrella of [1,2,3,4,5]">
                  <i class="bi"
                     [ngClass]="{
                       'bi-star-fill text-warning': estrella <= prod.valoracion_cliente,
                       'bi-star text-muted': estrella > prod.valoracion_cliente
                     }"></i>
                </ng-container>
              </div>

              <ng-template #valorar>
                <div class="d-flex flex-wrap gap-3">
                  <button *ngIf="empresa.estado_envio === 'entregado'"
                          class="btn btn-link p-0 fw-semibold d-flex align-items-center text-dark"
                          (click)="openReviewModal(prod.producto_id, pedido.cliente_id)">
                    <i class="bi bi-star-fill me-2"></i> Valorar el producto
                  </button>
                </div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scroll infinito -->
  <div
    infiniteScroll
    [infiniteScrollDistance]="2"
    [infiniteScrollThrottle]="300"
    [infiniteScrollDisabled]="isLoadingMore || currentPage > totalPages"
    (scrolled)="cargarMasPedidos()">
  </div>

  <!-- Cargando más -->
  <div class="text-center py-3" *ngIf="isLoadingMore">
    <div class="spinner-border text-success" role="status">
      <span class="visually-hidden">Cargando más pedidos...</span>
    </div>
  </div>
</ng-container>

<!-- Modal para dejar reseña -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">Dejar reseña</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3 text-center">
              <label class="form-label fw-bold">Calificación</label>
              <div class="star-rating d-flex justify-content-center gap-2">
                <i class="bi"
                   *ngFor="let star of [1,2,3,4,5]"
                   [ngClass]="{
                     'bi-star-fill': star <= reviewData.valoracion,
                     'bi-star': star > reviewData.valoracion,
                     'text-warning': star <= reviewData.valoracion,
                     'text-secondary': star > reviewData.valoracion
                   }"
                   class="fs-2 pointer"
                   (click)="setRating(star)"> 
                </i>
              </div>
            </div>
            <div class="mb-3">
              <label for="comentario" class="form-label">Comentario</label>
              <textarea class="form-control" id="comentario" rows="3" [(ngModel)]="reviewData.comentario" name="comentario"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="submitReview()">Enviar reseña</button> 
        </div>
      </div>
    </div>
  </div>